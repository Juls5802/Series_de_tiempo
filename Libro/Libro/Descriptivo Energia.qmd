# An谩lisis del consumo de energ铆a de la empresa PJM

```{r}
#| warning: false
#| message: false
# Librer铆as necesarias
library(TSstudio)
library(readxl)
library(dplyr)
library(lubridate)
library(astsa)
library(feasts)
library(fable)
library(timetk)
library(tsibble)
library(zoo)
library(xts)
library(readxl)
library(tidyverse)
library(nonlinearTseries)
library(tseriesChaos) 
library(forecast)
library(plotly)
```

```{r}
#| warning: false

# Carga de la base de datos
AEP_hourly<-read.csv("AEP_hourly.csv")
AEP_hourly$Datetime<-as.POSIXct(AEP_hourly$Datetime, format = "%Y-%m-%d %H:%M:%S")
AEP_hourly$fecha<-as.Date(AEP_hourly$Datetime)

energia <- AEP_hourly %>%
  group_by(fecha) %>%
  summarise(Energia = sum(AEP_MW))
energia<-energia[-5055,]
energia2<-ts(energia$Energia,start=c(2004,10,01),frequency=365.25)
```

Seg煤n lo observado en la serie de tiempo (@fig-serieenergia2), visualmente se tiene:

```{r}
#| label: fig-serieenergia2
#| fig-cap: >
#|    Gr谩fico de la verosimilitud en funci贸n del hiperpar谩metro lambda.

# Gr谩fico de la serie de tiempo
energia2<-ts(energia$Energia,start=c(2004,10,01),frequency=365.25)
plot(energia2, main="Serie de tiempo de la energ铆a diaria de una empresa estadounidense",
     cex.main=1,
     xlab="Tiempo ",
     ylab="Energ铆a consumida",
     cex.lab=0.4)
```

-   **Heterocedasticidad marginal:** Se puede observar que la varianza de cada instante en la serie es casi la misma. Al parecer no es necesario estabilizar la varianza.
-   **Tendencia:** A simple vista se observa que, a medida que pasa el tiempo la serie oscila al rededor del mismo valor, por lo tanto, no es necesario estimar la tendencia.
-   **Componente estacional:** Se observan algunos patrones que se repiten con cierta periodicidad, lo cual hace que sea necesario observar la posible presencia de componente estacional y posteriormente estimarla.

## Estabilizaci贸n de la varianza marginal

Como se observa en la gr谩fica de la serie de tiempo no es necesario realizar una estabilizaci贸n de la varianza para continuar con el an谩lisis descriptivo, sin embargo, para comprobar esto, se hace una transformaci贸n de Box-cox para ver que tanto se estabiliza la varianza. En la @fig-boxcox1energia se observa que se sugiere una transformaci贸n dado que 1 no est谩 contenido en el intervalo.

```{r}
#| label: fig-boxcox1energia
#| fig-cap: >
#|    Gr谩fico de la verosimilitud en funci贸n del hiperpar谩metro lambda.
MASS::boxcox(lm(energia2 ~ 1),seq(-5, 5, length = 50))
abline(v = 1, col = "red", lty = 2)
```

En la siguiente salida se puede ver que el $\lambda$ sugerido es $-0.25$, como es un n煤mero negativo, se procede a hacer la transformaci贸n Box-Cox usando logaritmo natural.

```{r}
forecast::BoxCox.lambda(energia2, method ="loglik",lower = -1, upper = 3)
```

En la @fig-boxcox1lenergia a continuaci贸n se muestra que la serie en escala logar铆tmica nuevamente no tiene la varianza estabilizada, dado que no se contiene al 1.

```{r}
#| label: fig-boxcox1lenergia
#| fig-cap: >
#|    Gr谩fico de la verosimilitud para la serie en escala logar铆tmica, en funci贸n del hiperpar谩metro lambda.
lenergia2=log(energia2)
MASS::boxcox(lm(lenergia2 ~ 1),seq(-5, 5, length =  50))
abline(v = 1, col = "red", lty = 2)
```

Adem谩s, se puede notar en la @fig-sinconboxcoxenerg , que no hay una diferencia significativa entre la serie transformada y no transformada. Por lo que el an谩lisis descriptivo se contin煤a usando los datos originales.

```{r}
#| label: fig-sinconboxcoxenerg
#| fig-cap: >
#|    Serie original y serie con transformaci贸n logar铆tmica.
par(mar = c(1,1,1,1))
par(mfrow=c(2,1),mar=c(3,3,3,3))
plot(energia2,main="Serie energ铆a sin Transformar",cex.main=1)
plot(lenergia2,main="Serie energ铆a con Transformaci贸n BoxCox",cex.main=1)
```

## Estimaci贸n de la tendencia

Como se observa en la gr谩fica de la serie de tiempo no es necesario realizar una estimaci贸n de la tendencia para continuar con el an谩lisis descriptivo, sin embargo, se hace una estimaci贸n preliminar usando varios m茅todos, con el fin de comprobar que la serie sin tendencia no var铆a mucho.

### Tendencia lineal

```{r}
# Creaci贸n del objeto tibble
energia_1=energia %>% map_df(rev)
Fechas=as.Date(energia_1$fecha)
energia_xts=xts(x = energia_1$Energia,frequency = 365.25,order.by = Fechas)

# Creaci贸n objeto tssible a partir del objeto tibble
df_energia=data.frame(Energia=energia_1$Energia,fecha=energia_1$fecha)
tbl_energia=tibble(df_energia)
tbl_energia_format_fecha=tbl_energia
tsbl_energia=as_tsibble(tbl_energia_format_fecha,index=fecha)
```

En la siguiente salida se presenta el ajuste de una regresi贸n lineal para estimar la tendencia. El $R^2$ ind铆ca qu茅 tan bien se ajusta la recta a los datos, en este caso tiene un valor de $0.058$, por lo que sugiere que no hay tendencia lineal.

```{r}
# An谩lisis de tendencia con regresion simple
summary(fit_e<-lm(energia2~time(energia2),na.action=NULL))
```

En la @fig-serietiempoenergiareglineal se presenta la serie de tiempo de la energ铆a con la estimaci贸n lineal de la tendencia.

```{r}
#| label: fig-serietiempoenergiareglineal
#| fig-cap: >
#|    Gr谩fico de la serie de tiempo de la energ铆a con la estimaci贸n lineal de la tendencia.

plot(energia2, main="Serie de tiempo de la energ铆a diaria de una empresa estadounidense",
     cex.main=1,
     xlab="Tiempo ",
     ylab="Energ铆a consumida",
     cex.lab=0.4)
abline(fit_e,col="darkcyan",lwd=2)
```

Posteriormente, se procede a eliminar la tendencia lineal, como se puede ver en la @fig-serietiempoenergiasintendreglineal .

```{r}
#| label: fig-serietiempoenergiasintendreglineal
#| fig-cap: >
#|    Gr谩fico de la serie de tiempo de la energ铆a sin tendencia estimada con regresi贸n lineal.

# Eliminaci贸n de la tendencia con la predicci贸n la recta
ElimiTendenerg<-energia2-predict(fit_e)
plot(ElimiTendenerg,main="Serie energ铆a sin tendencia",
     cex.main=1.3,
     xlab="Tiempo",
     ylab="Consumo de energ铆a",
     cex.lab=0.4)
```

### Tendencia con promedios m贸viles

En la @fig-serietiempoenergiaprommovil , se muestra un ajuste de la tendencia con promedios m贸viles, como se puede ver, aparentemente hay una sobrestimaci贸n de la tendencia, ya que muestra comportamientos que no son tan visibles en la serie de tiempo original.

```{r}
#| label: fig-serietiempoenergiaprommovil
#| fig-cap: >
#|    Gr谩fico de la serie de tiempo de la energ铆a sin tendencia estimada con promedios m贸viles.

# Descomposici贸n filtro de promedios m贸viles
energia_decompo=decompose(energia2)
plot(energia_decompo)
```

### Tendencia con diferenciaci贸n

En la @fig-serietiempoenergiadiff se presentan los gr谩ficos de las series sin tendencia, estimada con regresi贸n lineal y con diferenciaci贸n respectivamente, se puede notar que la serie sin tendencia estimada con diferenciaci贸n impide ver los ciclos que se ven en la serie original.

```{r}
#| label: fig-serietiempoenergiadiff
#| fig-cap: >
#|    Gr谩fico de la serie de tiempo de la energ铆a sin tendencia estimada con regresi贸n lineal y diferenciaci贸n.

tsibble_energia<-as_tsibble(energia2)
par(mar = c(2,2,2,2))
par(mfrow=c(2,1))

plot(resid(fit_e), type="l", main="Sin tendencia lineal") 
plot(diff(energia2), type="l", main="Primera Diferencia") 
```

### Comparaci贸n de los ACF

En la @fig-serietiempoenergiaacf se puede notar un descenso r谩pido hacia 0 para las series original y sin tendencia estimada con regresi贸n lineal, mientras que para la serie sin tendencia estimada con diferenciaci贸n, se puede apreciar mejor el ciclo estacional de aproximadamente 7 d铆as.

```{r}
#| label: fig-serietiempoenergiaacf
#| fig-cap: >
#|    Gr谩ficos de autocorrelaci贸n para la serie original, sin tendencia estimada con regresi贸n lineal y con la primera diferencia.

# Gr谩ficos de los ACF
par(mar = c(3,2,3,2))
par(mfrow=c(3,1))
acf(energia2, 60, main="ACF energia")
acf(resid(fit_e), 60, main="ACF Sin tendencia") 
acf(diff(energia2), 60, main="ACF Primera Diferencia")
```

Si bien se estima la tendencia con diferentes m茅todos, se decide trabajar con la serie sin tendencia l铆neal.

## Gr谩ficas de retardos e 铆ndice AMI

```{r}
par(mar = c(3, 2, 3, 2))
astsa::lag1.plot(ElimiTendenerg, 7,corr=F)
```
```{r}
tseriesChaos::mutual(ElimiTendenerg, partitions = 50, lag.max = 10, plot=TRUE) # AMI serie sin tendencia lineal
```

Es posible ver que el primer rezago reduce el estado de incertidumbre para la observaci贸n en el tiempo $t$.

## Estimaci贸n de la estacionalidad

### Detecci贸n de estacionalidad

```{r}
#| warning: false
lineal_1<-cbind(as.matrix(ElimiTendenerg),as.character(energia$fecha))
lineal_1<-as.data.frame(lineal_1)
names(lineal_1)<-c("Energia","fecha")

lineal_1$Energia<-as.numeric(lineal_1$Energia)
lineal_1$fecha<-as.Date(lineal_1$fecha)

df_lineal=data.frame(Energia=lineal_1$Energia,fecha=lineal_1$fecha)
tbl_lineal=tibble(df_lineal)
tbl_lineal_format_fecha=tbl_lineal
tsbl_lineal=as_tsibble(tbl_lineal_format_fecha,index=fecha)
```

En la @fig-serietiempoenergiasubseriediar se presenta el gr谩fico de subseries diarias para la serie original, se puede ver que hay estacionalidad ya que el valor medio del d铆a domingo por ejemplo, es menor al del resto de d铆as.

```{r}
#| label: fig-serietiempoenergiasubseriediar
#| fig-cap: >
#|    Gr谩fica de subseries diarias.

# Gr谩fica de subseries semanal con datos originales
gg_subseries(tsbl_lineal,y=Energia,period=7)
```

En la @fig-serietiempoenergiasubseriean se presenta el gr谩fico de subseries mensuales para la serie original, se puede ver que no hay ciclos estacionales mensuales, ya que todos tienen la misma media. Sin embargo, esto puede deberse a la presencia de la m煤lriple estacionalidad.

```{r}
#| label: fig-serietiempoenergiasubseriean
#| fig-cap: >
#|    Gr谩fica de subseries anuales.

# Gr谩fica de subseries anual con datos originales
gg_subseries(tsbl_lineal,y=Energia,period=12)
```


```{r}
#| warning: false
energia_df<-cbind(as.matrix(ElimiTendenerg),as.character(energia$fecha))
energia_df<-as.data.frame(energia_df)
names(energia_df)<-c("Energia","Fecha")

energia_df$Fecha<-as.Date(energia_df$Fecha)
energia_df$time = as.POSIXct(energia_df$Fecha, "%Y-%m-%d")
energia_df$weekday <- wday(energia_df$time, label = TRUE, abbr = TRUE)
energia_df$month <- factor(month.abb[month(energia_df$time)], levels =   month.abb)

# Agrupamos por mes y d铆a
energia_df$Energia<-as.numeric(energia_df$Energia)
energia_mensual <- energia_df %>%
  dplyr::filter(weekday == "dom\\." | weekday == "mar\\." ) %>% # martes se parece al comportamiento de lunes-viernes, domingo se parece a sabado
  dplyr::group_by(weekday, month) %>%
  dplyr::summarise(mean = mean(Energia, na.rm = TRUE),
                   sd = sd(Energia, na.rm = TRUE))

# Grafico consumo (diferenciado) de energia mensual por dia
plot_ly(data = energia_mensual, x = ~ month, y = ~ mean, type =
          "bar",color = ~ weekday) %>%
  layout(title = "Promedio diario de energ铆a por d铆a de la semana",
         yaxis = list(title = "Media"),
         xaxis = list(title = "Mes"))

```


### Periodograma

En la @fig-periodlinealenerg se presenta el periodograma para la serie sin tendencia lineal, el valor del periodo donde se maximiza el periodograma nuevamente es $182.86$, es decir, aproximadamente, el ciclo es de medio a帽o.

```{r}
#| label: fig-periodlinealenerg
#| fig-cap: >
#|    Periodograma para la serie sin tendencia lineal.

# Periodograma sin tendencia lineal
spectrum(as.numeric(ElimiTendenerg),log='no')

PeriodogramaEnergia2_lineal=spectrum(as.numeric(ElimiTendenerg),log='no')
ubicacionlogenergia=which.max(PeriodogramaEnergia2_lineal$spec)

sprintf("El valor de la frecuencia donde se maximiza el periodograma para la serie es: %s",PeriodogramaEnergia2_lineal$freq[ubicacionlogenergia])

sprintf("El periodo correspondiente es aproximadamente: %s",1/PeriodogramaEnergia2_lineal$freq[ubicacionlogenergia])
```

#### Para la serie sin tendencia usando diferenciaci贸n

En la @fig-perioddiffenerg se presenta el periodograma para la serie sin tendencia estimada usando diferenciaci贸n, el valor del periodo donde se maximiza el periodograma es $3.5$, es decir, aproximadamente, el ciclo es de tres d铆as.

```{r}
#| label: fig-perioddiffenerg
#| fig-cap: >
#|    Periodograma para la serie sin tendencia usando diferenciaci贸n.

# Periodograma diferenciaci贸n
spectrum(as.numeric(diff(energia2)),log='no')

PeriodogramaEnergia2_dif=spectrum(as.numeric(diff(energia2)),log='no')
ubicacionlogenergia=which.max(PeriodogramaEnergia2_dif$spec)

sprintf("El valor de la frecuencia donde se maximiza el periodograma para la serie es: %s",PeriodogramaEnergia2_dif$freq[ubicacionlogenergia])

sprintf("El periodo correspondiente es aproximadamente: %s",1/PeriodogramaEnergia2_dif$freq[ubicacionlogenergia])
```

### Estimaci贸n

Ahora procederemos a estimar el ciclo estacional que se observa en esta serie de tiempo, es importante resaltar que con ayuda de los graficos exploratorios y el periodograma se observo que el periodo de la componente estacional es $s=12$, por lo tanto utilizaremos en primer lugar componentes de fourier, esto teniendo en cuenta que se aprecia que la componente estacional sigue un comportamiento deterministico y posiblemente sinosoidal. Teniendo lo anterior en cuenta el modelo viene dado por: $$\begin{align*} x_t&= _{i=1}^k a_icos(kt)+b_isen(kt) + w_t \\ \end{align*}$$ Donde $k$ corresponder谩 al orden de la expansi贸n en series de Fourier y los coeficientes $a_i$ y $b_i$ con $i=1,...,k$ ser谩n estimados a trav茅s del m茅todo de m铆nimos cuadrados. El c谩lculo de esta componente se muestra a continuaci贸n considerando un orden $k=3$.


```{r}
# Frecuencia angular w=2*pi/s
frec_ang=(2*pi/182)
frec_ang2=(2*pi/7)

energia_copia<-cbind(as.matrix(ElimiTendenerg),as.character(energia$fecha))
energia_copia<-as.data.frame(energia_copia)
names(energia_copia)<-c("Energia","fecha")

energia_copia$fecha<-as.Date(energia_copia$fecha)

#Fourier k=1 
energia_copia$sin = sin(c(1:5054)*(1*frec_ang))
energia_copia$cos = cos(c(1:5054)*(1*frec_ang))

#Fourier k=2 
energia_copia$sin2 = sin(c(1:5054)*(2*frec_ang))
energia_copia$cos2 = cos(c(1:5054)*(2*frec_ang))

#Fourier k=3 
energia_copia$sin3 = sin(c(1:5054)*(3*frec_ang))
energia_copia$cos3 = cos(c(1:5054)*(3*frec_ang))


#Fourier k=1 
energia_copia$sin4 = sin(c(1:5054)*(1*frec_ang2))
energia_copia$cos4 = cos(c(1:5054)*(1*frec_ang2))

#Fourier k=2 
energia_copia$sin5 = sin(c(1:5054)*(2*frec_ang2))
energia_copia$cos5 = cos(c(1:5054)*(2*frec_ang2))

#Fourier k=3 
energia_copia$sin6 = sin(c(1:5054)*(3*frec_ang2))
energia_copia$cos6 = cos(c(1:5054)*(3*frec_ang2))

linmodel_ciclo<-lm(Energia~1+sin+cos+sin2+cos2+sin3+cos3+sin4+cos4+sin5+cos5+sin6+cos6,data=energia_copia)

results_ciclo=linmodel_ciclo$fitted.values
results_ciclo<-as.data.frame(results_ciclo)
results_ciclo_ts<-ts(results_ciclo,start=c(2004,10,01),frequency=365.25)

plot(ElimiTendenerg, main="Serie de tiempo de la energ铆a diaria de una empresa estadounidense",
     cex.main=1.3,
     xlab="Tiempo ",
     ylab="Energ铆a consumida",
     cex.lab=0.4)
lines(results_ciclo_ts,col="red")

plot(ElimiTendenerg, main="Serie de tiempo de la energ铆a diaria de una empresa estadounidense",
     cex.main=1.3,
     xlab="Tiempo ",
     ylab="Energ铆a consumida",
     cex.lab=0.4,
     xlim=c(2004,2007))
lines(results_ciclo_ts,col="red",xlim=c(2004,2007))
```

En la @fig-energestacionalidad se presenta la serie original con la estimaci贸n de la componente estacional via componentes de Fourier y la serie sin estacionalidad. Se puede notar que las componentes de Fourier logran captar bien es c铆clo estacional que tiene la serie. Se toma una componente de Fourier, ya que no hay una diferencia visible al utilizar 2 y 3.

```{r}
#| label: fig-energestacionalidad
#| fig-cap: >
#|    Serie original con estamaci贸n de la componente estacional y serie sin estacionalidad.

energia_estacionarios<-ElimiTendenerg-results_ciclo_ts
saveRDS(energia_estacionarios, file="energia_estacionarios.RDS")
plot(ElimiTendenerg-results_ciclo_ts)
plot(ElimiTendenerg-results_ciclo_ts,xlim=c(2004,2007))
```


A continuaci贸n, presentaremos el modelo de 谩rboles y ell modelo de redes neuronales multicapa paraa esta serie de tiempo, disponible [aqu铆](https://github.com/Juls5802/Series_de_tiempo/blob/main/Energia.ipynb).